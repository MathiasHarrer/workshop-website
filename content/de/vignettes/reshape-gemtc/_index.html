---
title: "Reshaping Network Meta-Analysis Datasets: netmeta to gemtc"
subtitle: "Vignette"
author: "Mathias Harrer"
date: "2021-06-07"
output:
  html_document:
    css: "style.css"
---



<style type="text/css">
body, td {
   font-size: 18px;
}
code.r{
  font-size: 16px;
}
pre {
  font-size: 16px
}
</style>
<div id="synopsis" class="section level1">
<h1>Synopsis</h1>
<p>To conduct a meta-analysis of (contrast-based) effect size data (i.e. pre-calculated effect sizes of treatment comparisons along with their standard error), different data entry formats are needed for <em>{netmeta}</em> and <em>{gemtc}</em>.</p>
<p>In <a href="https://cran.r-project.org/web/packages/netmeta/netmeta.pdf"><em>{netmeta}</em></a>, each treatment comparison/effect size corresponds with one line in the data set. The <code>treat1</code> and <code>treat2</code> columns are used to encode the two treatments that are being compared. This can be seen as a “wider” data format.</p>
<p>In <a href="https://cran.r-project.org/web/packages/gemtc/gemtc.pdf"><em>{gemtc}</em></a>, relative effect data has to be provided in a “longer” format. Each treatment comparison consists of two rows. In the first one, the calculated effect (e.g. SMD, MD, logOR) and its standard error is provided. The second row contains the name of the reference treatment (i.e. the treatment to which the treatment in the first row was compared to), and <code>NA</code> in the effect size and standard error columns (provided the comparison is <em>not</em> part of a multi-arm study; see below).</p>
<p>In our assessment, the data format in <em>{netmeta}</em> is closer to how network meta-analysis data is usually collected, for example in <em>Excel</em> sheets. In this vignette, we will therefore show how to reshape network meta-analysis data from the “wider” <em>{netmeta}</em> to the “longer” <em>{gemtc}</em> format.</p>
<p>More information on <em>{netmeta}</em>, <em>{gemtc}</em> and network meta-analysis can be found in the <a href="https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/">“Doing Meta-Analysis in R”</a> guide.</p>
<p><br></br></p>
</div>
<div id="reshaping" class="section level1">
<h1>Reshaping</h1>
<p>In this vignette, we will reshape the <code>TherapyFormats</code> data set. This data set is part of <a href="https://www.dmetar.protectlab.org"><em>{dmetar}</em></a>, but can also be downloaded as an <code>.rda</code> file <a href="https://www.protectlab.org/meta-analysis-in-r/data/TherapyFormats.rda">here</a>.</p>
<p><font size="3"></p>
<pre class="r"><code>library(dmetar)

# Load `TherapyFormats` data set
data(TherapyFormats)
head(TherapyFormats[,1:5])</code></pre>
<pre><code>##          author     TE  seTE treat1 treat2
## 1  Ausbun, 1997  0.092 0.195    ind    grp
## 2  Crable, 1986 -0.675 0.350    ind    grp
## 3  Thiede, 2011 -0.107 0.198    ind    grp
## 4 Bonertz, 2015 -0.090 0.324    ind    grp
## 5     Joy, 2002 -0.135 0.453    ind    grp
## 6   Jones, 2013 -0.217 0.289    ind    grp</code></pre>
<p></font></p>
<p>This data set can be used in <em>{netmeta}</em> as is. To conduct a network meta-analysis on the same data in <em>{gemtc}</em>, however, we have to bring it in a “longer” format. This can be achieved using the <a href="https://tidyr.tidyverse.org/reference/pivot_longer.html"><code>pivot_longer</code></a> function in the <a href="https://tidyr.tidyverse.org/index.html"><em>{tidyr}</em></a> package. For this example, we also have to load the <a href="https://dplyr.tidyverse.org/index.html"><em>{dplyr}</em></a> und <a href="https://magrittr.tidyverse.org/"><em>{magrittr}</em></a> package additionally.</p>
<p>It may take some time to get to accustomed to the logic of <code>pivot_longer</code>, but the function is generally very intuitive and powerful. If you want to learn more about <code>pivot_longer</code>, and its counterpart <code>pivot_wider</code>, you can have a look at this <a href="https://tidyr.tidyverse.org/articles/pivot.html">vignette</a>.</p>
<p>To pivot the data, we (1) select the first five columns in <code>TherapyFormats</code>, (2) forward the result in a pipe to <code>pivot_longer</code>, and then (3) define the column names needed for the <code>data.re</code> argument for relative effect size data in <a href="https://www.rdocumentation.org/packages/gemtc/versions/0.8-8/topics/mtc.network"><code>mtc.network</code></a>.</p>
<pre class="r"><code>library(dplyr)
library(tidyr)
library(magrittr)

TherapyFormats %&gt;%
  dplyr::select(1:5) %&gt;%
  pivot_longer(-author,
               names_to = c(&quot;.value&quot;),
               names_pattern = &quot;(..)&quot;) %&gt;% 
  set_colnames(c(&quot;study&quot;, &quot;diff&quot;, 
                 &quot;std.err&quot;, &quot;treatment&quot;)) -&gt; data</code></pre>
<p>Now, let us have a look at the new data format.</p>
<pre class="r"><code>head(data, 10)</code></pre>
<pre><code>## # A tibble: 10 x 4
##    study            diff std.err treatment
##    &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    
##  1 Ausbun, 1997   0.092    0.195 ind      
##  2 Ausbun, 1997  NA       NA     grp      
##  3 Crable, 1986  -0.675    0.35  ind      
##  4 Crable, 1986  NA       NA     grp      
##  5 Thiede, 2011  -0.107    0.198 ind      
##  6 Thiede, 2011  NA       NA     grp      
##  7 Bonertz, 2015 -0.0900   0.324 ind      
##  8 Bonertz, 2015 NA       NA     grp      
##  9 Joy, 2002     -0.135    0.453 ind      
## 10 Joy, 2002     NA       NA     grp</code></pre>
<p>We see that the data now has the desired “longer” format, where the reference group values for <code>diff</code> and <code>std.err</code> are <code>NA</code> in each trial.</p>
<p>It is also useful to create another data frame in which the full name of the treatments in our network is stored. This information can be added to the <code>treatments</code> argument in <code>mtc.network</code>, and makes it easier to create network plots further down the line, among other things. There are certainly more elegant approaches, but this is one way to create such a table:</p>
<pre class="r"><code>library(tibble)

# Show all treatments
unique(data$treatment)</code></pre>
<pre><code>## [1] &quot;ind&quot; &quot;grp&quot; &quot;gsh&quot; &quot;tel&quot; &quot;wlc&quot; &quot;cau&quot; &quot;ush&quot;</code></pre>
<pre class="r"><code>c(&quot;ind&quot; = &quot;Individual&quot;, 
  &quot;grp&quot; = &quot;Group&quot;,
  &quot;gsh&quot; = &quot;Guided Self-Help&quot;,
  &quot;tel&quot; = &quot;Telephone&quot;,
  &quot;wlc&quot; = &quot;Waitlist&quot;,
  &quot;cau&quot; = &quot;Care As Usual&quot;,
  &quot;ush&quot; = &quot;Unguided Self-Help&quot;) %&gt;% 
  data.frame() %&gt;% 
  set_colnames(&quot;description&quot;) %&gt;% 
  rownames_to_column(&quot;id&quot;) -&gt; treat.codes

treat.codes</code></pre>
<pre><code>##    id        description
## 1 ind         Individual
## 2 grp              Group
## 3 gsh   Guided Self-Help
## 4 tel          Telephone
## 5 wlc           Waitlist
## 6 cau      Care As Usual
## 7 ush Unguided Self-Help</code></pre>
<p>We can then put <code>data</code> and <code>treat.codes</code> into a <code>list</code> so we have all the information in one place.</p>
<pre class="r"><code>TherapyFormatsGeMTC &lt;- list(data = data, 
                            treat.codes = treat.codes)</code></pre>
<p><br></br></p>
</div>
<div id="multi-arm-trials" class="section level1">
<h1>Multi-Arm Trials</h1>
<p>Since our data contains a multi-arm trial, we cannot yet use the generated data set in <em>{gemtc}</em> as is. For multi-arm trials, more than one effect size is calculated, and these effect sizes are usually correlated. Suppose a trial contains <span class="math inline">\(J=3\)</span> conditions; A, B and C. Using a A as the reference group, we can calculate two effect sizes, one for the A-B and another for the A-C comparison. Since A is used twice, the effect sizes are assumed to be correlated (see e.g. Borenstein et al., chapter 25). To account for this non-independence in multi-arm trials, we also need to specify the standard error of the <strong>reference arm</strong> before we can model our data in <em>{gemtc}</em>.</p>
<p>Franchini and colleagues (<a href="https://doi.org/10.1002/jrsm.1049">2012</a>) have shown that the standard error of the base arm is equal to the square root of the <em>covariance</em> between the treatment contrasts. The problem is that this covariance between treatment comparisons is hardly ever reported in published articles. This means that the value has to be imputed. Franchini et al. mention several, partly quite sophisticated approaches to estimate the covariance between contrast-level data in multi-arm trials. When dealing with log-odds ratios as the summary measure, the simplest way is to calculate the <span class="math inline">\(\text{SE}\)</span> of the log-odds in the reference arm.</p>
<p>Since our data includes only one three-arm study and two-arm studies otherwise, we will use a rather simple approach in this example. As mentioned, the required standard error in the base/reference arm can be calculated as the square root of the covariance between the two calculated effects in our multi-arm study. Since <span class="math inline">\(\text{Cov}(x,y) = \text{Cor}(x,y)\sqrt{\text{Var}(x)\text{Var}(y)}\)</span>, the following formula can be applied to estimate the reference arm standard error (Schwarzer et al., 2015, chapter 7.1):</p>
<p><span class="math display">\[~\]</span></p>
<p><span class="math display">\[\text{SE}_{i,j=1} = (\text{Cov}[y^{\text{con}}_{t_{i,1},t_{i,2}},y^{\text{con}}_{t_{i,1},t_{i,3}}])^{0.5} ~\hat{=}~ (\text{SE}^{\text{con}}_{t_{i,1},t_{i,2}}\text{SE}^{\text{con}}_{t_{i,1},t_{i,3}} \hat\rho_{\delta_{i,12}\delta_{i,13}})^{0.5}\]</span></p>
<p><span class="math display">\[~\]</span></p>
<p>Where <span class="math inline">\(\text{SE}_{i,j=1}\)</span> is the standard error in arm 1 (the base arm) of trial <span class="math inline">\(i\)</span>. The value of <span class="math inline">\(\hat\rho_{\delta_{i,12}\delta_{i,13}}\)</span> is our estimate of the true correlation between the two effect sizes calculated for <span class="math inline">\(i\)</span>. This correlation depends on the design of the study, but will usually hover around 0.5 (see e.g. Borenstein et al., chapter 25). Using the formula above, we can also conduct <em>sensitivity analyses</em> for varying values of <span class="math inline">\(\hat\rho_{\delta_{i,12}\delta_{i,13}}\)</span> and check how they affect our final results.</p>
<p>In our example data set, the study by Breiman (2001) is a multi-arm trial:</p>
<pre class="r"><code># Show studies with more than two conditions
TherapyFormatsGeMTC$data %&gt;% 
  pull(study) %&gt;% 
  table() %&gt;% 
  {.[. &gt; 2]}</code></pre>
<pre><code>## Breiman, 2001 
##             6</code></pre>
<pre class="r"><code># Select Breiman, 2001 study
TherapyFormatsGeMTC$data %&gt;% 
  filter(study == &quot;Breiman, 2001&quot;)</code></pre>
<pre><code>## # A tibble: 6 x 4
##   study           diff std.err treatment
##   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    
## 1 Breiman, 2001 -0.085   0.516 ind      
## 2 Breiman, 2001 NA      NA     gsh      
## 3 Breiman, 2001 -0.75    0.513 ind      
## 4 Breiman, 2001 NA      NA     wlc      
## 5 Breiman, 2001 -0.664   0.514 gsh      
## 6 Breiman, 2001 NA      NA     wlc</code></pre>
<p>There are two problems concerning the data format of this trial. First, there is one “redundant” effect size. To use <em>{gemtc}</em>, we have to make sure that effect sizes in multi-arm studies are always based on the same reference group. In our example, this is <code>wlc</code>. We can remove the first two lines corresponding with the <code>ind</code> vs. <code>gsh</code> comparison, since this effect can be derived from the other two contrasts anyway (effect sizes in multiarm trials are consistent by design). The fourth line can also be removed because we do not want to specify the base arm twice.</p>
<pre class="r"><code>TherapyFormatsGeMTC$data &lt;- TherapyFormatsGeMTC$data[-c(15,16,32),]</code></pre>
<p>Furthermore, in the <code>std.err</code> column, we have to replace <code>NA</code> with the standard error of the base arm (for <code>wlc</code>). Assuming <span class="math inline">\(\hat\rho=0.5\)</span> for the correlation of the treatment comparisons, for example, we can estimate the co-variance, and thus the standard error for the base arm <code>wlc</code>.</p>
<pre class="r"><code># Show base arm SE
se.base &lt;- sqrt(0.513*0.514*0.5)

se.base</code></pre>
<pre><code>## [1] 0.3630992</code></pre>
<pre class="r"><code># The wlc arm is in row 365
TherapyFormatsGeMTC$data[365, &quot;std.err&quot;] &lt;- se.base</code></pre>
<p>Let us check how the final data structure looks like for our multi-arm trial:</p>
<pre class="r"><code>TherapyFormatsGeMTC$data %&gt;% 
  filter(study == &quot;Breiman, 2001&quot;)</code></pre>
<pre><code>## # A tibble: 3 x 4
##   study           diff std.err treatment
##   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    
## 1 Breiman, 2001 -0.75    0.513 ind      
## 2 Breiman, 2001 -0.664   0.514 gsh      
## 3 Breiman, 2001 NA       0.363 wlc</code></pre>
<p>As mentioned above, when it is unclear what the true value of <span class="math inline">\(\hat\rho\)</span> is, one may assume different values of <span class="math inline">\(0&lt;\hat\rho&lt;1\)</span>, and check to what extent these different assumption affect the overall results of the network meta-analysis using <em>{gemtc}</em>.</p>
<p><br></br></p>
<div id="references" class="section level2">
<h2>References</h2>
<p><strong>Borenstein</strong>, M., Hedges, L. V., Higgins, J. P., &amp; Rothstein, H. R. (2011). <em>Introduction to meta-analysis</em>. John Wiley &amp; Sons.</p>
<p><strong>Franchini</strong>, A. J., Dias, S., Ades, A. E., Jansen, J. P., &amp; Welton, N. J. (2012). Accounting for correlation in network meta‐analysis with multi‐arm trials. <em>Research Synthesis Methods, 3</em>(2), 142-160.</p>
<p><strong>Schwarzer</strong>, G., Carpenter, J. R., &amp; Rücker, G. (2015). <em>Meta-analysis with R</em>. New York: Springer.</p>
</div>
</div>
